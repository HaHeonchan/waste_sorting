<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>쓰레기 민원 게시판</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 40px auto; }
    .report { border: 1px solid #ddd; margin-bottom: 12px; padding: 12px; border-radius: 8px;}
    .date { color: #888; font-size: 0.9em;}
    .del-btn { color: red; cursor: pointer; }
    .edit-btn { color: #0a67d6; cursor: pointer; margin-left: 8px; }
    #form-div, #edit-div {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 16px;
      margin: 18px 0;
    }
    #edit-div { display: none; }
  </style>
</head>
<body>
  <h1>민원 제보 게시판</h1>
  <button onclick="showForm()">+ 민원 제보</button>

  <!-- 민원 작성 폼 -->
  <div id="form-div" style="display:none;">
    <h2>민원 작성</h2>
    <form id="reportForm" enctype="multipart/form-data">
      <input type="file" name="image" accept="image/*" /><br>
      <textarea name="content" placeholder="민원 내용" required></textarea><br>
      <select name="reward_type" required>
        <option value="" disabled selected>포상금 유형 선택</option>
        <option value="a">가. 담배꽁초, 휴지 등 휴대하고 있는 폐기물을 버린 경우 (20,000원)</option>
        <option value="b">나. 폐기물을 비닐봉지 등에 담아 아무 곳에나 버리는 행위 (100,000원)</option>
        <option value="c">다. 공원, 유원지 등에서 발생한 폐기물을 수거하지 아니하는 행위 (100,000원)</option>
        <option value="d">라. 차량, 손수레 등 운반장비로 폐기물 버리는 행위 (200,000원)</option>
        <option value="e">마. 사업활동 과정에서 발생 폐기물 (400,000원)</option>
        <option value="f">바. 기타 금액 미상</option>
      </select><br>
      <button type="submit">제보</button>
      <button type="button" onclick="hideForm()">취소</button>
    </form>
  </div>
  
  <!-- 민원 수정 폼 (동적으로 생성/표시) -->
  <div id="edit-div"></div>

  <h2>내 민원 목록</h2>
  <div id="reports"></div>

  <script>
    // 포상금 매핑
    const rewardAmountMap = {
      a: "20,000원 상당",
      b: "100,000원 상당",
      c: "100,000원 상당",
      d: "200,000원 상당",
      e: "400,000원 상당",
      f: "금액 미상"
    };

    let reports = [];

    function showForm() {
      document.getElementById('form-div').style.display = '';
      hideEditForm();
    }
    function hideForm() {
      document.getElementById('form-div').style.display = 'none';
    }

    function editForm(reportId) {
        const report = reports.find(r => r.report_id == reportId);
        const editDiv = document.getElementById('edit-div');
        hideForm();
        if (!report) return;
        // (여기서 reward_type도 수정 가능하게 하려면 select 태그도 추가 가능)
        editDiv.innerHTML = `
          <h2>민원 수정</h2>
          <form id="editForm" enctype="multipart/form-data">
            <input type="file" name="image" accept="image/*" /><br>
            <textarea name="content" required style="width:100%; min-height:60px">${report.content}</textarea><br>
            <button type="submit">저장</button>
            <button type="button" onclick="hideEditForm()">취소</button>
          </form>
        `;
        editDiv.style.display = 'block';
        document.getElementById('editForm').onsubmit = async function(e) {
          e.preventDefault();
          const formData = new FormData(e.target);
          await fetch(`/api/reports/${reportId}`, {
            method: 'PUT',
            body: formData
          });
          hideEditForm();
          fetchReports();
        };
    }
    function hideEditForm() {
      const editDiv = document.getElementById('edit-div');
      editDiv.style.display = 'none';
      editDiv.innerHTML = '';
    }

    async function fetchReports() {
      const res = await fetch('/api/reports');
      const list = await res.json();
      reports = list;
      const reportsDiv = document.getElementById('reports');
      reportsDiv.innerHTML = '';
      list.forEach(r => {
        reportsDiv.innerHTML += `
          <div class="report">
            <div><b>${r.content}</b></div>
            ${r.image_url ? `<img src="${r.image_url}" width="100" style="margin:8px 0"/><br>` : ''}
            <div><b>포상금 지급액:</b> ${rewardAmountMap[r.reward_type] || '-'}</div>
            <div class="date">${new Date(r.created_at).toLocaleString()}</div>
            <div><b>상태:</b> ${r.status || '미정'}</div>
            <button class="del-btn" onclick="del(${r.report_id})">삭제</button>
            <button class="edit-btn" onclick="editForm(${r.report_id})">수정</button>
          </div>`;
      });
    }
    fetchReports();

    document.getElementById('reportForm').onsubmit = async function(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      await fetch('/api/reports', {
        method: 'POST',
        body: formData,
      });
      hideForm();
      form.reset();
      fetchReports();
    }

    async function del(id) {
      await fetch(`/api/reports/${id}`, { method: 'DELETE' });
      fetchReports();
    }
  </script>
</body>
</html>
